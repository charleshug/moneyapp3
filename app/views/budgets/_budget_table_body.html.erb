<tbody id="budget-table-tbody">
  <!-- Per-month budget summary: one cell per month with label+value lines, text shrinks -->
  <tr class="bg-gray-50">
    <td class="px-4 py-2 w-48 min-w-48"></td>
    <% @display_months.each_with_index do |_month, i| %>
      <% s = @summary_by_month[i] %>
      <% vals = [s[:budget_available_previously], s[:overspent_prev], s[:income_current], -s[:budget_current], s[:budget_available_current]] %>
      <% labels = [
            s[:budget_available_previously] < 0 ? "Overbudgeted in Prev" : "Not budgeted in Prev",
            "Overspent in Prev",
            "Income for Current",
            "Budgeted in Current",
            s[:budget_available_current] < 0 ? "Overbudgeted" : "Available to budget in Current"
          ] %>
      <td colspan="3" class="px-2 py-1 border-l-2 border-r-2 border-gray-400 align-top min-w-[400px] <%= budget_month_col_visible(i) %>" data-month-index="<%= i %>">
        <div class="text-sm whitespace-nowrap" style="line-height: 1.35;">
          <% labels.each_with_index do |label, row_idx| %>
            <% if row_idx == 4 %>
              <div class="mt-1 text-center" data-summary-line="available">
                <div class="text-3xl font-bold <%= vals[row_idx] < 0 ? 'text-red-600' : '' %>"><%= number_to_currency(vals[row_idx] / 100.0) %></div>
                <div class="text-base text-gray-600"><%= label %></div>
              </div>
            <% elsif row_idx == 3 %>
              <div class="flex" data-summary-line="budgeted">
                <span class="w-1/2 text-right pr-1 <%= vals[row_idx] < 0 ? 'text-red-600' : '' %>"><%= number_to_currency(vals[row_idx] / 100.0) %></span>
                <span class="w-1/2 text-left pl-1 text-gray-600"><%= label %></span>
              </div>
            <% else %>
              <div class="flex">
                <span class="w-1/2 text-right pr-1 <%= vals[row_idx] < 0 ? 'text-red-600' : '' %>"><%= number_to_currency(vals[row_idx] / 100.0) %></span>
                <span class="w-1/2 text-left pl-1 text-gray-600"><%= label %></span>
              </div>
            <% end %>
          <% end %>
        </div>
      </td>
    <% end %>
  </tr>
  <tr class="border-t border-gray-300">
    <td colspan="<%= 1 + @display_months.size * 3 %>" class="py-0"></td>
  </tr>
  <!-- Labels row: Budget, Actual, Balance directly above totals -->
  <tr class="bg-gray-100 text-gray-600">
    <td class="px-4 py-0.5 min-w-48"></td>
    <% @display_months.each_with_index do |_month, i| %>
      <td class="px-2 py-0.5 text-right border-l-2 border-gray-400 font-medium <%= budget_month_cell_min %> <%= budget_month_col_visible(i) %>">Budget</td>
      <td class="px-2 py-0.5 text-right font-medium <%= budget_month_cell_min %> <%= budget_month_col_visible(i) %>">Actual</td>
      <td class="px-2 py-0.5 text-right border-r-2 border-gray-400 font-medium <%= budget_month_cell_min %> <%= budget_month_col_visible(i) %>">Balance</td>
    <% end %>
  </tr>
  <!-- Totals row -->
  <tr class="bg-gray-100" data-budget-totals-row>
    <td class="px-4 py-2 min-w-48"></td>
    <% @display_months.each_with_index do |_month, i| %>
      <% data = @budget_table_data_by_month[i] %>
      <td class="px-2 py-1 text-right border-l-2 border-gray-400 <%= budget_month_cell_min %> <%= budget_month_col_visible(i) %>" data-month-index="<%= i %>" data-total-type="budget"><strong><%= number_to_currency(data.sum { |p| p[:budget] } / 100.0) %></strong></td>
      <td class="px-2 py-1 text-right <%= budget_month_cell_min %> <%= budget_month_col_visible(i) %>" data-month-index="<%= i %>" data-total-type="actual"><strong><%= number_to_currency(data.sum { |p| p[:actual] } / 100.0) %></strong></td>
      <% tot_bal = data.sum { |p| p[:balance] } %>
      <td class="px-2 py-1 text-right border-r-2 border-gray-400 <%= budget_month_cell_min %> <%= budget_month_col_visible(i) %>" data-month-index="<%= i %>" data-total-type="balance"><strong class="<%= tot_bal < 0 ? 'text-red-600' : '' %>"><%= number_to_currency(tot_bal / 100.0) %></strong></td>
    <% end %>
  </tr>
  <tr class="border-t border-b border-gray-200">
    <td colspan="<%= 1 + @display_months.size * 3 %>" class="py-1"></td>
  </tr>
  <% @budget_table_data.each_with_index do |parent, cat_idx| %>
    <tr class="bg-gray-100" data-category-id="<%= parent[:id] %>">
      <td class="px-4 py-2 min-w-48"><strong><%= parent[:name] %></strong></td>
      <% @display_months.each_with_index do |month, i| %>
        <% p = @budget_table_data_by_month[i][cat_idx] %>
        <td class="px-2 py-1 text-right border-l-2 border-gray-400 <%= budget_month_cell_min %> <%= budget_month_col_visible(i) %>" data-month-index="<%= i %>" data-category-type="budget"><strong><%= number_to_currency(p[:budget] / 100.0) %></strong></td>
        <td class="px-2 py-1 text-right <%= budget_month_cell_min %> <%= budget_month_col_visible(i) %>" data-month-index="<%= i %>" data-category-type="actual"><strong><%= link_to number_to_currency(p[:actual] / 100.0), trxes_path(q: { lines_ledger_subcategory_category_id_in: parent[:id], date_gteq: month.beginning_of_month, date_lteq: month.end_of_month }) %></strong></td>
        <td class="px-2 py-1 text-right border-r-2 border-gray-400 <%= budget_month_cell_min %> <%= budget_month_col_visible(i) %>" data-month-index="<%= i %>" data-category-type="balance"><strong class="<%= p[:balance] < 0 ? 'text-red-600' : '' %>"><%= number_to_currency(p[:balance] / 100.0) %></strong></td>
      <% end %>
    </tr>
    <% parent[:subcategories].each_with_index do |subcategory, sub_idx| %>
      <tr class="hover:bg-gray-50">
        <td class="px-4 py-2 pl-8 min-w-48"><%= subcategory[:name] %></td>
        <% @display_months.each_with_index do |month, i| %>
          <% s = @budget_table_data_by_month[i][cat_idx][:subcategories][sub_idx] %>
          <% if s[:ledger] %>
            <td class="px-2 py-1 text-right cursor-pointer hover:bg-blue-50 border-l-2 border-gray-400 <%= budget_month_cell_min %> <%= budget_month_col_visible(i) %>"
                data-controller="inline-budget"
                data-inline-budget-subcategory-id-value="<%= subcategory[:id] %>"
                data-inline-budget-ledger-id-value="<%= s[:ledger].id %>"
                data-inline-budget-date-value="<%= month %>"
                data-inline-budget-month-index-value="<%= i %>"
                data-inline-budget-current-budget-value="<%= s[:budget] / 100.0 %>"
                data-action="click->inline-budget#startEdit"
                data-inline-budget-target="cell">
              <%= number_to_currency(s[:budget] / 100.0) %>
            </td>
            <td class="px-2 py-1 text-right <%= budget_month_cell_min %> <%= budget_month_col_visible(i) %>" data-month-index="<%= i %>"><%= link_to number_to_currency(s[:actual] / 100.0), trxes_path(q: { lines_ledger_subcategory_id_in: subcategory[:id], date_gteq: month.beginning_of_month, date_lteq: month.end_of_month }) %></td>
          <% else %>
            <td class="px-2 py-1 text-right cursor-pointer hover:bg-blue-50 border-l-2 border-gray-400 <%= budget_month_cell_min %> <%= budget_month_col_visible(i) %>"
                data-controller="inline-budget"
                data-inline-budget-subcategory-id-value="<%= subcategory[:id] %>"
                data-inline-budget-ledger-id-value=""
                data-inline-budget-date-value="<%= month %>"
                data-inline-budget-month-index-value="<%= i %>"
                data-inline-budget-current-budget-value="0"
                data-action="click->inline-budget#startEdit"
                data-inline-budget-target="cell">
              <%= number_to_currency(0 / 100.0) %>
            </td>
            <td class="px-2 py-1 text-right <%= budget_month_cell_min %> <%= budget_month_col_visible(i) %>" data-month-index="<%= i %>"><%= number_to_currency(0 / 100.0) %></td>
          <% end %>
          <td class="px-2 py-1 text-right border-r-2 border-gray-400 <%= budget_month_cell_min %> <%= budget_month_col_visible(i) %>" data-month-index="<%= i %>">
            <% if s[:ledger] %>
              <%= link_to overspending_settings_ledger_path(s[:ledger]), data: { turbo_frame: "modal", controller: "modal-opener", action: "click->modal-opener#storePosition" }, class: "cursor-pointer hover:bg-blue-100 rounded px-1 -mx-1 #{s[:balance] < 0 ? 'text-red-600' : ''}" do %>
                <%= number_to_currency(s[:balance] / 100.0) %>
                <% if s[:balance] < 0 && s[:carry_forward] %>
                  <i class="fa-solid fa-arrow-right ml-0.5" aria-hidden="true"></i>
                <% end %>
              <% end %>
            <% else %>
              <span class="<%= s[:balance] < 0 ? 'text-red-600' : '' %>">
                <%= number_to_currency(s[:balance] / 100.0) %>
                <% if s[:balance] < 0 && s[:carry_forward] %>
                  <i class="fa-solid fa-arrow-right ml-0.5" aria-hidden="true"></i>
                <% end %>
              </span>
            <% end %>
          </td>
        <% end %>
      </tr>
    <% end %>
  <% end %>
</tbody>
