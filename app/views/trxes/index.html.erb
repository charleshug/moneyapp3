<% provide(:title, "Transactions") %>
<h1>Trxes</h1>

<%= search_form_for @q do |f| %>
  <div style="display: flex; ">
    <div style="display: flex; flex-direction: column;">
      <div><%= f.label :date_gteq, 'From Date' %></div>
      <div><%= f.date_field :date_gteq %></div>
    </div>
    <div style="display: flex; flex-direction: column;">
      <div><%= f.label :date_lteq, 'To Date' %></div>
      <div><%= f.date_field :date_lteq %></div>
    </div>
  </div>
  <div>
    <%= f.label :account_id_in, 'Account' %>
    <%= f.collection_select :account_id_in, @current_budget.accounts, :id, :name, {include_blank: true}, {multiple: true} %>
  </div>
  <div>    
    <%= f.label :lines_ledger_subcategory_category_id_in, 'Category' %>
    <%= f.collection_select(
      :lines_ledger_subcategory_category_id_in,
      @current_budget.categories,
      :id,
      :name,
      {include_blank: true, multiple: true}
    ) %>
  <div>    
    <%= f.label :lines_ledger_subcategory_id_in, 'Subcategory' %>
    <%= f.grouped_collection_select(
      :lines_ledger_subcategory_id_in,
      @current_budget.categories,
      :subcategories,
      :name,
      :id,
      :name,
      {include_blank: true},
      {multiple: true}
    ) %>
  </div>
  <div>
    <%= f.label :vendor_id_in, 'Vendor' %>
    <%= f.collection_select :vendor_id_in, @current_budget.vendors.order('LOWER(name)'), :id, :name, {include_blank: true}, {multiple: true} %>
  </div>
  <div>
  <%= f.submit "Filter" %>
  </div>
<% end %>

<table>
  <thead>

      <th style="border: 1px solid #ddd; padding: 4px 8px;">Date</th>
      <th style="border: 1px solid #ddd; padding: 4px 8px;">Amount</th>
      <th style="border: 1px solid #ddd; padding: 4px 8px;">Vendor</th>
      <th style="border: 1px solid #ddd; padding: 4px 8px;">Account</th>
      <th style="border: 1px solid #ddd; padding: 4px 8px;">Category</th>
      <th style="border: 1px solid #ddd; padding: 4px 8px;">Subcategory</th>
      <th style="border: 1px solid #ddd; padding: 4px 8px;">Memo</th>
      <th style="border: 1px solid #ddd; padding: 4px 8px;">Cleared</th>
      <th style="border: 1px solid #ddd; padding: 4px 8px;">ID</th>
      <th style="border: 1px solid #ddd; padding: 4px 8px;">Transfer?</th>
    </tr>
  </thead>
  <tbody>
    <% @trxes.each do |trx| %>
      <tr>
        <td style="border: 1px solid #ddd; padding: 4px 8px; white-space: nowrap;"><%= trx.date.strftime("%b %d '%y") %></td>
        <td style="border: 1px solid #ddd; padding: 4px 8px; text-align: right;"><%= number_to_currency((trx.amount / 100.0)) %></td>
        <td style="border: 1px solid #ddd; padding: 4px 8px; white-space: nowrap;"><%= trx.vendor.name %></td>
        <td style="border: 1px solid #ddd; padding: 4px 8px;"><%= trx.account.name %></td>
        <% if trx.lines.count > 1%>
          <td style="border: 1px solid #ddd; padding: 4px 8px; white-space: nowrap;">Split Transaction</td>
          <td style="border: 1px solid #ddd; padding: 4px 8px; white-space: nowrap;">Various</td>
        <% elsif trx.lines.count > 0 %>
          <td style="border: 1px solid #ddd; padding: 4px 8px; white-space: nowrap;"><%= trx.lines.first.ledger.category.name %></td>
          <td style="border: 1px solid #ddd; padding: 4px 8px; white-space: nowrap;"><%= trx.lines.first.ledger.subcategory.name %></td>
        <% else %>
          <td style="border: 1px solid #ddd; padding: 4px 8px; white-space: nowrap;">No Lines</td>
          <td style="border: 1px solid #ddd; padding: 4px 8px; white-space: nowrap;">No Lines</td>
        <% end %>
        <td style="border: 1px solid #ddd; padding: 4px 8px; white-space: nowrap;"><%= trx.memo %></td>
        <td style="border: 1px solid #ddd; padding: 4px 8px;"><%= check_box_tag nil, nil, trx.cleared, disabled: true %></td>
        <td style="border: 1px solid #ddd; padding: 4px 8px;"><%= link_to trx.id, edit_trx_path(trx) %></td>
        <% if trx.lines.any? { |line| line.transfer_line.present? }%>
          <td style="border: 1px solid #ddd; padding: 4px 8px;">Yes</td>
        <% else %>
          <td style="border: 1px solid #ddd; padding: 4px 8px;"></td>
        <% end %>
      </tr>
    <% end %>
  </tbody>
</table>

<% if @pagy.pages > 1 %>
  <nav aria-label="Pagination" class="justify-content-center d-inline">
    <% if @pagy.prev %>
      <%= link_to 'First', url_for(request.query_parameters.merge(page: 1)), class: 'page-link' %>
    <% end %>
    <% if @pagy.prev %>
      <%= link_to 'Previous', url_for(request.query_parameters.merge(page: @pagy.prev)), class: 'page-link' %>
    <% end %>
    
    <% @pagy.series.each do |page| %>
      <%= link_to page, url_for(request.query_parameters.merge(page: page)), class: 'page-link' %>
    <% end %>
    
    <% if @pagy.next %>
      <%= link_to 'Next', url_for(request.query_parameters.merge(page: @pagy.next)), class: 'page-link' %>
      <%= link_to 'Last', url_for(request.query_parameters.merge(page: @pagy.pages)), class: 'page-link' %>
    <% end %>
  </nav>
<% end %>

<%= link_to "Export to CSV", url_for(controller: 'trxes', action: 'csv_export', format: :csv) %>