<% provide(:title, "Transactions") %>

<style>
  .selected-row {
    background-color: #fef3c7 !important; /* bg-yellow-200 */
  }
  .selected-row:hover {
    background-color: #fef3c7 !important; /* Keep yellow on hover */
  }
</style>

<div class="bg-gray-100 shadow-md overflow-hidden flex flex-col" style="height: 100vh;" data-controller="trx-selection">

  <!-- filter -->
  <%= render 'trxes/filter_sidebar' %>

  <!-- New Transaction Button and Form Container -->
  <div data-controller="trx-form-toggle">
    <!-- New Transaction Button -->
    <div class="bg-white shadow-sm p-2 border-b border-gray-200 sticky top-0 z-10">
      <button data-trx-form-toggle-target="button" 
              data-action="click->trx-form-toggle#showForm" 
              class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md">
        <i class="fas fa-plus mr-2"></i> New Transaction
      </button>
    </div>

    <!-- Inline New Transaction Form (hidden by default) -->
    <div data-trx-form-toggle-target="form" 
         class="hidden bg-blue-50 border-b border-gray-200 p-2">
    <% @inline_trx = Trx.new %>
    <% @inline_trx.lines.build %>
    <%= form_with(model: @inline_trx, url: trxes_path, local: false, 
                  data: { controller: "trx-form", trx_form_target: "form", action: "submit->trx-form#submitForm" }) do |f| %>
      <div class="grid grid-cols-9 items-center text-center gap-2">
        <div class="text-gray-500 text-sm">New</div>
        
        <!-- Account -->
        <div>
          <%= f.select :account_id,
              grouped_options_for_select(@current_budget.accounts.for_select, nil),
              { prompt: 'Select Account' },
              { class: "w-full text-sm rounded border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" } %>
        </div>
        
        <!-- Date -->
        <div>
          <%= f.date_field :date, 
              value: Date.today,
              class: "w-full text-sm rounded border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" %>
        </div>
        
        <!-- Vendor -->
        <div data-controller="vendor-autocomplete" 
             data-vendor-autocomplete-search-url-value="<%= search_vendors_path %>"
             data-vendor-autocomplete-budget-id-value="<%= @current_budget.id %>">
          <%= f.text_field :vendor_custom_text, 
              placeholder: "Type vendor name...", 
              class: "w-full text-sm rounded border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50",
              data: { 
                vendor_autocomplete_target: "input",
                action: "input->vendor-autocomplete#search focus->vendor-autocomplete#onFocus input->vendor-autocomplete#onInputChange"
              },
              list: "inline-vendor-datalist" %>
          <%= f.hidden_field :vendor_id, data: { vendor_autocomplete_target: "hiddenInput" } %>
          <datalist id="inline-vendor-datalist" data-vendor-autocomplete-target="datalist"></datalist>
        </div>
        
        <!-- Amount -->
        <div>
          <input type="number" 
                 data-trx-form-target="amountInput"
                 data-action="input->trx-form#syncAmount"
                 step="0.01"
                 placeholder="0.00"
                 class="w-full text-sm rounded border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" />
        </div>
        
        <!-- Category (will be populated by subcategory selection) -->
        <div data-trx-form-target="categoryDisplay" class="text-gray-500 text-sm">-</div>
        
        <!-- Subcategory -->
        <div>
          <select data-trx-form-target="subcategorySelect"
                  data-action="change->trx-form#updateCategory"
                  class="w-full text-sm rounded border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            <option value="">Select Subcategory</option>
            <% @current_budget.categories.each do |category| %>
              <optgroup label="<%= category.name %>">
                <% category.subcategories.each do |subcategory| %>
                  <option value="<%= subcategory.id %>"><%= subcategory.name %></option>
                <% end %>
              </optgroup>
            <% end %>
          </select>
        </div>
        
        <!-- Memo -->
        <div>
          <%= f.text_field :memo, 
              placeholder: "Memo",
              class: "w-full text-sm rounded border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" %>
        </div>
        
        <!-- Cleared checkbox -->
        <div>
          <%= f.check_box :cleared, 
              class: "rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50" %>
        </div>
      </div>
      
      <!-- Hidden line fields for the transaction -->
      <%= f.fields_for :lines do |line_form| %>
        <%= line_form.hidden_field :ledger_id %>
        <%= line_form.hidden_field :subcategory_form_id, data: { trx_form_target: "lineSubcategoryInput" } %>
        <%= line_form.hidden_field :amount, data: { trx_form_target: "lineAmountInput" } %>
      <% end %>
      
      <!-- Action buttons -->
      <div class="mt-2 flex justify-center gap-2">
        <button type="submit" class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white rounded text-sm">
          <i class="fas fa-save mr-1"></i> Save
        </button>
        <button type="button" 
                data-action="click->trx-form-toggle#hideForm"
                class="px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white rounded text-sm">
          <i class="fas fa-times mr-1"></i> Cancel
        </button>
      </div>
    <% end %>
    </div>
  </div>

  <!-- Transactions list -->
<div class="flex flex-col flex-grow overflow-hidden">
  <% if @trxes.any? %>
    <!-- Header row -->
    <div class="bg-white shadow-sm p-1 border-b border-gray-200 sticky top-0 z-10">
      <div class="grid items-center font-medium text-blue-600" style="grid-template-columns: 40px 60px 100px 100px 1fr 100px 100px 1fr 1fr 60px;">
        <div class="text-center px-2">
          <input type="checkbox" 
                 data-trx-selection-target="headerCheckbox"
                 data-action="click->trx-selection#toggleAll"
                 class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
        </div>
        <div class="text-left border-l border-gray-300 px-2">ID</div>
        <div class="text-left border-l border-gray-300 px-2">Account</div>
        <div class="text-left border-l border-gray-300 px-2">Date</div>
        <div class="text-left border-l border-gray-300 px-2">Vendor</div>
        <div class="text-left border-l border-gray-300 px-2">Amount</div>
        <div class="text-left border-l border-gray-300 px-2">Category</div>
        <div class="text-left border-l border-gray-300 px-2">Subcategory</div>
        <div class="text-left border-l border-gray-300 px-2">Memo</div>
        <div class="text-center border-l border-gray-300 px-2">Cleared</div>
      </div>
    </div>

    <!-- Scrollable data rows -->
    <div class="overflow-y-auto flex-grow">
      <% @trxes.each do |trx| %>
        <% if trx.lines.size == 1 %>
          <div class="odd:bg-white even:bg-blue-50 bg-white shadow-sm p-1 hover:bg-gray-50 border-b border-gray-200 cursor-pointer"
               data-trx-selection-target="row"
               data-trx-id="<%= trx.id %>"
               data-action="click->trx-selection#selectRow">
            <div class="grid items-center text-gray-800" style="grid-template-columns: 40px 60px 100px 100px 1fr 100px 100px 1fr 1fr 60px;">
              <div class="px-2">
                <input type="checkbox" 
                       data-trx-selection-target="checkbox"
                       data-trx-id="<%= trx.id %>"
                       data-action="click->trx-selection#toggleSelection"
                       class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
              </div>
              <div class="truncate text-left px-2"><%= trx.id %></div>
              <div class="truncate text-left px-2"><%= trx.account.name %></div>
              <div class="truncate text-left px-2"><%= trx.date %></div>
              <div class="truncate text-left px-2"><%= trx.vendor.name %></div>
              <div class="truncate text-left px-2" data-trx-selection-target="amount" data-amount="<%= trx.amount %>"><%= number_to_currency(trx.amount / 100.0) %></div>
              <div class="truncate text-left px-2"><%= trx.lines.first&.ledger&.subcategory&.category&.name %></div>
              <div class="truncate text-left px-2"><%= trx.lines.first&.ledger&.subcategory&.name %></div>
              <div class="truncate text-left px-2" title="<%= trx.memo %>"><%= trx.memo %></div>
              <div data-controller="cleared-toggle"
                  data-cleared-toggle-trx-id-value="<%= trx.id %>"
                  data-cleared-toggle-cleared-value="<%= trx.cleared %>">
                <button data-action="click->cleared-toggle#toggle" class="focus:outline-none">
                  <div data-cleared-toggle-target="circle"
                      class="w-4 h-4 rounded-full <%= trx.cleared ? 'bg-green-500' : 'bg-gray-300' %> mx-auto">
                  </div>
                </button>
              </div>
            </div>
          </div>
        <% else %>
          <div class="odd:bg-white even:bg-blue-50 bg-white shadow-sm p-1 hover:bg-gray-50 border-b border-gray-200 cursor-pointer"
               data-trx-selection-target="row"
               data-trx-id="<%= trx.id %>"
               data-action="click->trx-selection#selectRow">
            <div class="grid items-center text-gray-800" style="grid-template-columns: 40px 60px 100px 100px 1fr 100px 100px 1fr 1fr 60px;">
              <div class="px-2">
                <input type="checkbox" 
                       data-trx-selection-target="checkbox"
                       data-trx-id="<%= trx.id %>"
                       data-action="click->trx-selection#toggleSelection"
                       class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
              </div>
              <div class="truncate text-left px-2"><%= trx.id %></div>
              <div class="truncate text-left px-2"><%= trx.account.name %></div>
              <div class="truncate text-left px-2"><%= trx.date %></div>
              <div class="truncate text-left px-2"><%= trx.vendor.name %></div>
              <div class="truncate text-left px-2" data-trx-selection-target="amount" data-amount="<%= trx.amount %>"><%= number_to_currency(trx.amount / 100.0) %></div>
              <div class="truncate text-left px-2"></div>
              <div class="truncate text-left px-2">Split (Multiple Categories)...</div>
              <div class="truncate text-left px-2" title="<%= trx.memo %>"><%= trx.memo %></div>
              <div data-controller="cleared-toggle"
                  data-cleared-toggle-trx-id-value="<%= trx.id %>"
                  data-cleared-toggle-cleared-value="<%= trx.cleared %>">
                <button data-action="click->cleared-toggle#toggle" class="focus:outline-none">
                  <div data-cleared-toggle-target="circle"
                      class="w-4 h-4 rounded-full <%= trx.cleared ? 'bg-green-500' : 'bg-gray-300' %> mx-auto">
                  </div>
                </button>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>

    <!-- Footer -->
    <div class="mt-4 flex justify-between items-center sticky bottom-0 bg-gray-100 p-2 border-t border-gray-200">
      <div class="text-sm text-gray-600">
        <strong>Page:</strong> <%= pluralize(@trxes.size, 'transaction') %>
        <span class="mx-2">|</span>
        <strong>Total:</strong> <%= pluralize(@filtered_count, 'transaction') %>
      </div>
      <div>
        <%= custom_pagy_nav(@pagy) %>
      </div>
    </div>
  <% else %>
    <div class="flex-grow flex items-center justify-center">
      <div class="text-center p-8 bg-white rounded-lg shadow-sm max-w-md">
        <p class="text-gray-600 mb-4">No transactions found.</p>
        <%= link_to new_trx_path, class: "px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md inline-block" do %>
          <i class="fas fa-plus mr-2"></i> Create Your First Transaction
        <% end %>
      </div>
    </div>
  <% end %>
</div>

<!-- Bottom Section: Scheduled Transactions and Balance Information -->
<div class="bg-white border-t border-gray-200 p-4 z-20" style="height: 120px; flex-shrink: 0;" data-budget-id="<%= @current_budget.id %>" data-trx-selection-target="balanceDisplay">
  <div class="flex justify-between items-center">
    <!-- Left: Scheduled Transactions Button -->
    <div>
      <%= link_to scheduled_trxes_path, class: "px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-md inline-flex items-center relative" do %>
        <i class="fas fa-calendar-alt mr-2"></i> 
        <span class="text-center">
          <div>Scheduled</div>
          <div>Transactions</div>
        </span>
        <% scheduled_count = @current_budget.scheduled_trxes.where(active: true).count %>
        <% if scheduled_count > 0 %>
          <div class="absolute -top-2 -right-2 bg-gray-800 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center font-bold">
            <%= scheduled_count %>
          </div>
        <% end %>
      <% end %>
    </div>
    
    <!-- Right: Balance Information and Reconcile Button -->
    <div class="flex items-center gap-6">
      <!-- Balance Display Box -->
      <div data-trx-selection-target="balanceContainer">
        <%= render 'balance_display' %>
      </div>
      
      <!-- Reconcile Account Button -->
      <div>
        <button class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-md inline-flex items-center">
          <i class="fas fa-balance-scale mr-2"></i> 
          <span class="text-center">
            <div>Reconcile</div>
            <div>Account</div>
          </span>
        </button>
      </div>
    </div>
  </div>
</div>

